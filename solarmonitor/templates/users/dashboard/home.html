
{% extends "layout.html" %}

{% block header_add %}
<!-- Bootstrap Core CSS -->
<link href="{{ url_for('static', filename='css/energy_account_table.css') }}" rel="stylesheet">
{% endblock %}

{% block heading %}
{{ heading }}
{% endblock %}

{% block sub_heading %}
{{ sub_heading }}
{% endblock %}

{% block breadcrumbs %}
  {% for crumb, icon, url in breadcrumbs %}
    <li>
        <i class="fa fa-{{ icon }}"></i>  <a href="{{ url }}">{{ crumb }}</a>
    </li>
  {% endfor %}
{% endblock %}

{% block content %}
<div ng-controller='eventController'>
<div class="body-content" >
<div class="row">
  <div class="col col-xs-6">
    <div class="btn-group">
      <button id="reset_date" type="button" class="btn btn-primary">Select Date Range</button>
      <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        <span class="caret"></span>
        <span class="sr-only">Toggle Dropdown</span>
      </button>

      <ul class="dropdown-menu">
        <li><a id="ytddays" href="#" ng-click="getEvents(ytd)">YTD</a></li>
        <li><a id="90days" href="#" ng-click="getEvents(90)">90 days</a></li>
        <li><a id="60days" href="#" ng-click="getEvents(60)">60 days</a></li>
        <li><a id="30days" href="#" ng-click="getEvents(30)">30 days</a></li>
        <li><a id="14days" href="#" ng-click="getEvents(14)">14 days</a></li>
        <li><a id="7days" href="#" ng-click="getEvents(7)">7 days</a></li>
      </ul>
    </div>




      <!-- Modal -->




  </div>

</div>






<script type="text/javascript">
var oneDay = 24*60*60*1000; // hours*minutes*seconds*milliseconds
var secondDate = new Date();
var firstDate = new Date(secondDate.getFullYear(),01,01);
var ytddays = Math.round(Math.abs((firstDate.getTime() - secondDate.getTime())/(oneDay)))
var today = moment().subtract(1, 'days').format("YYYY-MM-DD");
$('#ytddays').click(function () {
var account_id = {{ account_id|safe }};
var thirtyDaysAgo = moment().subtract(ytddays, 'days').format("YYYY-MM-DD");
var url = "/users/dashboard/graph/update/" + account_id + "/" + thirtyDaysAgo + "/" + today;
  $.ajax({
      type: 'GET',
      url: url,
      success: function (data) {
          console.log(data);
          /*myChart.data.datasets[0].data = data.production_net_usage_percentage_graph.production_percentage;
          myChart.data.datasets[1].data = data.production_net_usage_percentage_graph.net_input;
          myChart.data.datasets[2].data = data.production_net_usage_percentage_graph.net_usage_percentage;
          myChart.data.labels = data.production_net_usage_percentage_graph.labels;
          myChart.update();

          myChart2.data.datasets[0].data = data.production_net_usage_graph.production;
          myChart2.data.datasets[1].data = data.production_net_usage_graph.net_usage;
          myChart2.data.labels = data.production_net_usage_graph.labels;
          myChart2.update();
          */

          myChart3.data.datasets[0].data = data.production_net_usage_graph.production;
          myChart3.data.datasets[1].data = data.net_usage_separated.net_usage_positive;
          myChart3.data.datasets[2].data = data.net_usage_separated.net_usage_negative;
          myChart3.data.labels = data.production_net_usage_graph.labels;
          myChart3.update();

          myChart4.data.datasets[0].data = data.cumulative.net_usage;
          myChart4.data.labels = data.cumulative.labels;
          myChart4.update();
      }
  });
});

var today = moment().subtract(1, 'days').format("YYYY-MM-DD");
$('#90days').click(function () {
var account_id = {{ account_id|safe }};
var thirtyDaysAgo = moment().subtract(90, 'days').format("YYYY-MM-DD");
var url = "/users/dashboard/graph/update/" + account_id + "/" + thirtyDaysAgo + "/" + today;
  $.ajax({
      type: 'GET',
      url: url,
      success: function (data) {
          console.log(data);
          /*myChart.data.datasets[0].data = data.production_net_usage_percentage_graph.production_percentage;
          myChart.data.datasets[1].data = data.production_net_usage_percentage_graph.net_input;
          myChart.data.datasets[2].data = data.production_net_usage_percentage_graph.net_usage_percentage;
          myChart.data.labels = data.production_net_usage_percentage_graph.labels;
          myChart.update();

          myChart2.data.datasets[0].data = data.production_net_usage_graph.production;
          myChart2.data.datasets[1].data = data.production_net_usage_graph.net_usage;
          myChart2.data.labels = data.production_net_usage_graph.labels;
          myChart2.update();
          */

          myChart3.data.datasets[0].data = data.production_net_usage_graph.production;
          myChart3.data.datasets[1].data = data.net_usage_separated.net_usage_positive;
          myChart3.data.datasets[2].data = data.net_usage_separated.net_usage_negative;
          myChart3.data.labels = data.production_net_usage_graph.labels;
          myChart3.update();

          myChart4.data.datasets[0].data = data.cumulative.net_usage;
          myChart4.data.labels = data.cumulative.labels;
          myChart4.update();
      }
  });
});


var today = moment().subtract(1, 'days').format("YYYY-MM-DD");
$('#60days').click(function () {
var account_id = {{ account_id|safe }};
var thirtyDaysAgo = moment().subtract(60, 'days').format("YYYY-MM-DD");
var url = "/users/dashboard/graph/update/" + account_id + "/" + thirtyDaysAgo + "/" + today;
  $.ajax({
      type: 'GET',
      url: url,
      success: function (data) {
          console.log(data);
          /*myChart.data.datasets[0].data = data.production_net_usage_percentage_graph.production_percentage;
          myChart.data.datasets[1].data = data.production_net_usage_percentage_graph.net_input;
          myChart.data.datasets[2].data = data.production_net_usage_percentage_graph.net_usage_percentage;
          myChart.data.labels = data.production_net_usage_percentage_graph.labels;
          myChart.update();

          myChart2.data.datasets[0].data = data.production_net_usage_graph.production;
          myChart2.data.datasets[1].data = data.production_net_usage_graph.net_usage;
          myChart2.data.labels = data.production_net_usage_graph.labels;
          myChart2.update();
          */

          myChart3.data.datasets[0].data = data.production_net_usage_graph.production;
          myChart3.data.datasets[1].data = data.net_usage_separated.net_usage_positive;
          myChart3.data.datasets[2].data = data.net_usage_separated.net_usage_negative;
          myChart3.data.labels = data.production_net_usage_graph.labels;
          myChart3.update();

          myChart4.data.datasets[0].data = data.cumulative.net_usage;
          myChart4.data.labels = data.cumulative.labels;
          myChart4.update();
      }
  });
});

  $('#30days').click(function () {
  var account_id = {{ account_id|safe }};
  var thirtyDaysAgo = moment().subtract(31, 'days').format("YYYY-MM-DD");
  var url = "/users/dashboard/graph/update/" + account_id + "/" + thirtyDaysAgo + "/" + today;
    $.ajax({
        type: 'GET',
        url: url,
        success: function (data) {
            console.log(data);
            /*myChart.data.datasets[0].data = data.production_net_usage_percentage_graph.production_percentage;
            myChart.data.datasets[1].data = data.production_net_usage_percentage_graph.net_input;
            myChart.data.datasets[2].data = data.production_net_usage_percentage_graph.net_usage_percentage;
            myChart.data.labels = data.production_net_usage_percentage_graph.labels;
            myChart.update();

            myChart2.data.datasets[0].data = data.production_net_usage_graph.production;
            myChart2.data.datasets[1].data = data.production_net_usage_graph.net_usage;
            myChart2.data.labels = data.production_net_usage_graph.labels;
            myChart2.update();
            */

            myChart3.data.datasets[0].data = data.production_net_usage_graph.production;
            myChart3.data.datasets[1].data = data.net_usage_separated.net_usage_positive;
            myChart3.data.datasets[2].data = data.net_usage_separated.net_usage_negative;
            myChart3.data.labels = data.production_net_usage_graph.labels;
            myChart3.update();

            myChart4.data.datasets[0].data = data.cumulative.net_usage;
            myChart4.data.labels = data.cumulative.labels;
            myChart4.update();
        }
    });
  });

  $('#14days').click(function () {
  var account_id = {{ account_id|safe }};
  var thirtyDaysAgo = moment().subtract(15, 'days').format("YYYY-MM-DD");
  var url = "/users/dashboard/graph/update/" + account_id + "/" + thirtyDaysAgo + "/" + today;
    $.ajax({
        type: 'GET',
        url: url,
        success: function (data) {
            console.log(data);
            /*myChart.data.datasets[0].data = data.production_net_usage_percentage_graph.production_percentage;
            myChart.data.datasets[1].data = data.production_net_usage_percentage_graph.net_input;
            myChart.data.datasets[2].data = data.production_net_usage_percentage_graph.net_usage_percentage;
            myChart.data.labels = data.production_net_usage_percentage_graph.labels;
            myChart.update();

            myChart2.data.datasets[0].data = data.production_net_usage_graph.production;
            myChart2.data.datasets[1].data = data.production_net_usage_graph.net_usage;
            myChart2.data.labels = data.production_net_usage_graph.labels;
            myChart2.update();
            */

            myChart3.data.datasets[0].data = data.production_net_usage_graph.production;
            myChart3.data.datasets[1].data = data.net_usage_separated.net_usage_positive;
            myChart3.data.datasets[2].data = data.net_usage_separated.net_usage_negative;
            myChart3.data.labels = data.production_net_usage_graph.labels;
            myChart3.update();

            myChart4.data.datasets[0].data = data.cumulative.net_usage;
            myChart4.data.labels = data.cumulative.labels;
            myChart4.update();
        }
    });
  });

  $('#7days').click(function () {
  var account_id = {{ account_id|safe }};
  var thirtyDaysAgo = moment().subtract(8, 'days').format("YYYY-MM-DD");
  var url = "/users/dashboard/graph/update/" + account_id + "/" + thirtyDaysAgo + "/" + today;
    $.ajax({
        type: 'GET',
        url: url,
        success: function (data) {
            console.log(data);
            /*
            myChart.data.datasets[0].data = data.production_net_usage_percentage_graph.production_percentage;
            myChart.data.datasets[1].data = data.production_net_usage_percentage_graph.net_input;
            myChart.data.datasets[2].data = data.production_net_usage_percentage_graph.net_usage_percentage;
            myChart.data.labels = data.production_net_usage_percentage_graph.labels;
            myChart.update();

            myChart2.data.datasets[0].data = data.production_net_usage_graph.production;
            myChart2.data.datasets[1].data = data.production_net_usage_graph.net_usage;
            myChart2.data.labels = data.production_net_usage_graph.labels;
            myChart2.update();*/

            myChart3.data.datasets[0].data = data.production_net_usage_graph.production;
            myChart3.data.datasets[1].data = data.net_usage_separated.net_usage_positive;
            myChart3.data.datasets[2].data = data.net_usage_separated.net_usage_negative;
            myChart3.data.labels = data.production_net_usage_graph.labels;
            myChart3.update();

            myChart4.data.datasets[0].data = data.cumulative.net_usage;
            myChart4.data.labels = data.cumulative.labels;
            myChart4.update();
        }
    });
  });




</script>
<br>

    <div class="row">
      <div class="col col-xs-6">
        <canvas id="myChart3" width="380" height="200"></canvas>
      </div>


    <div class="col col-xs-6">
      <canvas id="myChart4" width="380" height="200"></canvas>
    </div>
  </div>
    </div>



<script>

var data = {
labels: {{ prod_net_usg_pct['labels']|safe }},
datasets: [
    {
        label: 'Production %',
        backgroundColor: "rgba(43,83,207,0.2)",
        borderColor: "rgba(25,60,168,1)",
        borderWidth: 1,
        hoverBackgroundColor: "rgba(43,83,207,0.4)",
        hoverBorderColor: "rgba(25,60,168,1)",
        data: {{ prod_net_usg_pct['production_percentage']|safe }},
    },
    {
        label: 'Net Usage %',
        backgroundColor: "rgba(127,191,63,0.2)",
        borderColor: "rgba(9,174,9,1)",
        borderWidth: 1,
        hoverBackgroundColor: "rgba(127,191,63,0.4)",
        hoverBorderColor: "rgba(9,174,9,1)",
        data: {{ prod_net_usg_pct['net_input']|safe }},
    },
    {
        label: 'Net Input %',
        backgroundColor: "rgba(168,25,25,0.2)",
        borderColor: "rgba(138,16,16,1)",
        borderWidth: 1,
        hoverBackgroundColor: "rgba(168,25,25,0.4)",
        hoverBorderColor: "rgba(138,16,16,1)",
        data: {{ prod_net_usg_pct['net_usage_percentage']|safe }},
    },
]
};
var ctx = document.getElementById("myChart");
/*var myChart = new Chart(ctx, {
  type: 'bar',
  data: data,
  options: {
      scales: {
          yAxes: [{
              stacked: true,
              ticks: {
                  beginAtZero:true
              }
          }],
          xAxes: [{
              stacked: true
          }]
      }
  }
});
*/
</script>

<script>
var data = {
labels: {{ prod_net_usg['labels']|safe }},
datasets: [
    {
        label: 'Production kWh',
        backgroundColor: "rgba(43,83,207,0.2)",
        borderColor: "rgba(25,60,168,1)",
        borderWidth: 1,
        hoverBackgroundColor: "rgba(43,83,207,0.4)",
        hoverBorderColor: "rgba(25,60,168,1)",
        data: {{ prod_net_usg['production']|safe }},
    },
    {
        label: 'Net Usage',
        backgroundColor: "rgba(168,25,25,0.2)",
        borderColor: "rgba(138,16,16,1)",
        borderWidth: 1,
        hoverBackgroundColor: "rgba(168,25,25,0.4)",
        hoverBorderColor: "rgba(138,16,16,1)",
        data: {{ prod_net_usg['net_usage']|safe }},
    }
]
};
var ctx = document.getElementById("myChart2");
/*var myChart2 = new Chart(ctx, {
  type: 'bar',
  data: data,
  options: {
      scales: {
          yAxes: [{
              stacked: true,
              ticks: {
                  beginAtZero:true
              }
          }],
          xAxes: [{
              stacked: true
          }]
      }
  }
});*/

var data2 = {
labels: {{ prod_net_usg['labels']|safe }},
datasets: [
    {
        type: 'line',
        label: 'Production kWh',
        backgroundColor: "rgba(43,83,207,0.2)",
        borderColor: "rgba(25,60,168,1)",
        borderWidth: 1,
        hoverBackgroundColor: "rgba(43,83,207,0.4)",
        hoverBorderColor: "rgba(25,60,168,1)",
        data: {{ prod_net_usg['production']|safe }},
    },
    {
        type: 'bar',
        label: 'Net Input',
        backgroundColor: "rgba(168,25,25,0.2)",
        borderColor: "rgba(138,16,16,1)",
        borderWidth: 1,
        hoverBackgroundColor: "rgba(168,25,25,0.4)",
        hoverBorderColor: "rgba(138,16,16,1)",
        data: {{ prod_comb['net_usage_positive']|safe }},
    },
    {
        type: 'bar',
        label: 'Net Usage',
        backgroundColor: "rgba(127,191,63,0.2)",
        borderColor: "rgba(127,191,63,1)",
        borderWidth: 1,
        hoverBackgroundColor: "rgba(127,191,63,0.4)",
        hoverBorderColor: "rgba(127,191,63,1)",
        data: {{ prod_comb['net_usage_negative']|safe }},
    }
]
};
var ctx2 = document.getElementById("myChart3");
var myChart3 = new Chart(ctx2, {
  type: 'bar',
  data: data2,
  options: {
      scales: {
          yAxes: [{
              stacked: true,
              ticks: {
                  beginAtZero:true
              }
          }],
          xAxes: [{
              stacked: true
          }]
      }
  }
});

{% if cumulative %}
var data4 = {
labels: {{ cumulative['labels']|safe }},
datasets: [
    {
        type: 'line',
        label: 'Cumulative Usage since {{ solar_install_date | safe }}',
        backgroundColor: "rgba(207,249,117,0.05)",
        borderColor: "rgba(137,156,255,1)",
        borderWidth: 1,
        hoverBackgroundColor: "rgba(207,249,117,0.4)",
        hoverBorderColor: "rgba(207,249,117,1)",
        data: {{ cumulative['net_usage'] | safe }},
        yAxisID: "y-axis-0",
    }
]
};
var ctx4 = document.getElementById("myChart4");
var myChart4 = new Chart(ctx4, {
  type: 'bar',
  data: data4,
  options: {
      scales: {
          yAxes: [{

              ticks: {
                  beginAtZero:false
              },
              position: 'left',
              'id': 'y-axis-0'
          }, {

              ticks: {
                beginAtZero: true,
                steps: 10,
                stepValue: 5,
                max: 100
              },
              scaleLabel: {
                display: true,
                labelString: 'Dollars'
              },
              position: 'right',
              'id': 'y-axis-1'
          }],
          xAxes: [{
              stacked: true,
              ticks: {
                  beginAtZero:false
              }
          }]
      }
  }
});
{% endif %}
</script>

<div class="modal fade" id="eventModal" tabindex="-1" role="dialog" aria-labelledby="eventModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">Add Event</h4>
      </div>
      <div class="modal-body">
        <form id="add_event_form" class="form-horizontal" method='post' action="{{ url_for('dashboard.home') }}">
          <fieldset>

            {{ form.hidden_tag() }}

          <!-- Text input-->
          <div class="form-group">
            <label class="col-md-4 control-label" for="textinput">Event Type</label>
            <div class="col-md-4">
              {{ form.event_type(class="form-control input-md") }}

            </div>
          </div>

          <!-- Text input-->
          <div class="form-group">
            <label class="col-md-4 control-label" for="textinput">Info</label>
            <div class="col-md-4">
            {{ form.info(class="form-control input-md") }}

            </div>
          </div>

          <!-- Text input-->
          <div class="form-group">
            <label class="col-md-4 control-label" for="textinput">Date</label>
            <div class="col-md-4">
            {{ form.date(class="form-control input-md", id="datepicker1") }}

            <script type="text/javascript">

            $(document).ready(function() {
                $('#datepicker1').datepicker({
                  format: 'yyyy-mm-dd',
                  container:'#eventModal',
                  todayHighlight: true
                });
            })


            </script>

            </div>
          </div>





      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="submit" class="btn btn-primary">Save changes</button>
      </fieldset>
      </form>
      </div>
    </div>
  </div>
</div>
<button id="add_event" type="button" class="btn btn-primary" data-toggle="modal" data-target="#eventModal">Add Event</button>
<div class="row" ng-if="events != false" ng-cloak>
  <div class="col col-xs-6">
    <table class="table">
      <thead>
        <th>Time</th>
        <th>Type</th>
        <th>Info</th>
        <th></th>
      </thead>


    <tr ng-repeat="event in events">
      <td>[[ event.date ]]</td>
      <td>[[ event.event_type ]]</td>
      <td>[[ event.info ]]</td>
      <td><a href="/users/dashboard/del/[[event.id]]"<i class="fa fa-close" style="color:red"></i></a></td>
    </tr>

  </table>
  </div>
</div>
</div>

    </div>
</div>
{% endblock %}
